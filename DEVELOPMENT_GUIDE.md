# DEVELOPMENT_GUIDE.md

A complete on-boarding manual for contributors to **my-better-t-app**

---

## 1. Tech Stack at a Glance

- Runtime
  - Bun 1.2 (server & monorepo scripts)
  - Node 20 (Next.js 15 web app)
- Back-end
  - Hono 4 (Edge-friendly API framework)
  - tRPC 11 (fully type-safe RPC)
  - Drizzle ORM → PostgreSQL
  - Better Auth 1.3 (email + password, JWT cookies)
- Front-end
  - Next.js 15 App Router (RSC + Server Actions)
  - Tailwind 4, shadcn/ui
  - TanStack React-Query 5
- Tooling
  - Turborepo 2 (monorepo builds)
  - TypeScript 5.8 (strict)
  - SuperJSON (data ⇄ wire)

---

## 2. Repository Layout

```
syndg-better-test/
├─ apps/
│  ├─ server/         # Hono API & tRPC router (Bun runtime)
│  └─ web/            # Next.js 15 web app (Node runtime)
├─ packages/          # (optional) shared libs – currently empty
├─ .env*              # root-level secrets (ignored by git)
├─ turbo.json         # workspace pipelines
└─ README.md          # stack overview (auto-generated by BTS)
```

Important cross-links

| Path alias  | Purpose                                               | Defined in                 |
| ----------- | ----------------------------------------------------- | -------------------------- |
| `@/*`       | Local imports inside each app                         | `tsconfig.json` of the app |
| `@server/*` | Import server **types** into web (never runtime code) | `apps/web/tsconfig.json`   |

---

## 3. Prerequisites

- Bun ≥ 1.2.2
- Node ≥ 20 (needed by Next 15)
- PostgreSQL 14+ (local or remote)
- pnpm 8 **or** npm 10 **or** yarn (only for installing Bun’s deps on Windows)

---

## 4. First-time Setup

```bash
# 1. clone
git clone <repo> my-better-t-app && cd $_

# 2. install (uses Bun workspaces)
bun install

# 3. copy env templates
cp apps/server/.env.example apps/server/.env
cp apps/web/.env.example    apps/web/.env
cp .env.example             .env            # if present

# 4. fill mandatory vars
#   DATABASE_URL=postgres://...
#   BETTER_AUTH_SECRET=long-random
#   BETTER_AUTH_URL=http://localhost:3001        # same origin as web in dev
#   NEXT_PUBLIC_SERVER_URL=http://localhost:3001
#   CORS_ORIGIN=http://localhost:3001

# 5. push schema
bun db:push
```

---

## 5. Running the Project

Development (watches everything)

```bash
bun dev           # alias for `turbo dev`
```

- API (Hono) → http://localhost:3000
- Web (Next) → http://localhost:3001

Individual targets

```bash
bun dev:server    # API only
bun dev:web       # Web only
```

Production build

```bash
bun build         # turbo build -> output in apps/*/dist or .open-next
```

---

## 6. Database Workflows

| Task           | Script            | Notes                    |
| -------------- | ----------------- | ------------------------ |
| Push schema    | `bun db:push`     | Creates / updates tables |
| Generate SQL   | `bun db:generate` | For review               |
| Drizzle Studio | `bun db:studio`   | Local UI                 |
| Migrations     | `bun db:migrate`  | Replay on prod           |

All Drizzle tasks run inside `apps/server` (Bun).

---

## 7. Authentication Model

- Cookie name: `better-auth.session_token`
- HTTP-only, signed with `BETTER_AUTH_SECRET`
- Issued by Better Auth endpoints under `/api/auth/**`

Integration points

1. **API side** (`apps/server/src/lib/auth.ts`)

   ```ts
   export const auth = betterAuth({
     database: drizzleAdapter(db, {...}),
     plugins: [nextCookies()],        // auto-set cookies in Server Actions
   });
   ```

2. **Web side (RSC)**

   ```ts
   const session = await requireServerAuth(); // redirects if null
   ```

   `requireServerAuth` is backed by a request-scoped `cache()` that

   - clones `headers()`
   - injects `cookies()` into the `Cookie` header
   - calls `auth.api.getSession()`

---

## 8. tRPC Pattern (RSC-Ready)

Server utilities `apps/web/src/utils/trpc-server.ts`

- `getQueryClient()` – memoised per request
- `trpc` – `createTRPCOptionsProxy({ router, ctx, queryClient })`
- `trpcCaller()` – convenience `appRouter.createCaller(ctx)`

Client utilities `apps/web/src/utils/trpc-client.tsx`

- Provides one `QueryClient` per browser tab
- Exposes `useTRPC()` hook for components
- Wraps the entire tree in `TRPCReactProvider` from `app/layout.tsx`

Fetching styles

```tsx
// 1. RSC (prefetch)
await getQueryClient().prefetchQuery(trpc.posts.list.queryOptions());

// 2. Caller (simple await)
const post = await(await trpcCaller()).posts.byId({ id });

// 3. Client component
const { data } = useQuery(trpc.posts.list.queryOptions());
```

---

## 9. Recommended Dev Workflow

1. Start `bun dev` and keep it running.
2. Code changes in `apps/server` hot-reload via Bun’s `--hot`.
3. Web pages auto refresh thanks to Next 15.
4. Use **RSC** as default; add `"use client"` only where interactivity is
   needed.
5. Use `withServerAuth()` HOC (exported by
   `components/ServerProtectedWrapper.tsx`) to protect whole pages.

---

## 10. Coding Standards

- Strict TypeScript (`noImplicitAny`, `strictNullChecks`, etc.)
- `paths` alias only for **types** across apps; avoid importing runtime
  code from server into web.
- Keep environment access inside `lib/env.ts` (create if missing) to avoid
  undefined surprises.
- Prefer `const fn = cache(async () => …)` for any per-request expensive
  work.
- Use ⬚ bullet (`-`) for list items in Markdown docs.
- Commit messages:

  ```
  feat(server): add X
  fix(web): correct auth redirect
  chore: lint / dependency bumps
  ```

---

## 11. Testing (❄ placeholder)

- Unit tests planned with Vitest + ts-dom, not yet scaffolded.
- E2E tests will use Playwright once stable.

---

## 12. Deployment

Web (Next.js) is configured for Cloudflare Workers via
`apps/web/open-next.config.ts` + `wrangler.jsonc`.

API (Hono) can be deployed to Bun Edge Runtime or any Node host; for
Cloudflare you can run a separate worker bundle.

CI pipeline should:

- `bun install --frozen-lockfile`
- `bun check-types`
- `bun build`
- Deploy web worker → Cloudflare
- Deploy server → host / container / edge function

---

## 13. Common Troubleshooting

| Symptom                                     | Likely Cause                                                      | Fix                                                            |
| ------------------------------------------- | ----------------------------------------------------------------- | -------------------------------------------------------------- |
| `/dashboard` keeps redirecting to `/login`  | `BETTER_AUTH_SECRET` missing in Next env, or cookie not forwarded | Add secret to `.env`, ensure `requireServerAuth` logic present |
| BetterAuthError “invalid trusted origin”    | `CORS_ORIGIN` empty string                                        | Remove env or set correct origin                               |
| Drizzle “password authentication failed”    | bad `DATABASE_URL`                                                | Check user / password / host                                   |
| RSC bundling fails with Drizzle / Hono deps | importing runtime code from server into web                       | Import **types only** via `@server/*`                          |
